<!DOCTYPE html>
<html>
<head>
    <title>Мой Список Дел</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        /* Базовые стили */
        :root {
            --mobile-breakpoint: 768px;
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .task-item {
            padding: 1rem 0.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .task-item:hover {
            background-color: #f8f9fa;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }

        @media (max-width: 576px) {
            .badge {
                font-size: 0.65rem;
                padding: 0.2rem 0.4rem;
            }
        }

        .badge-high {
            background: linear-gradient(135deg, #ffeaea, #ffd0d0);
            color: #dc3545;
            border: 1px solid #ffcccc;
        }

        .badge-medium {
            background: linear-gradient(135deg, #fff3cd, #ffeaa4);
            color: #e6a700;
            border: 1px solid #ffeaa4;
        }

        .badge-low {
            background: linear-gradient(135deg, #d1e7dd, #b8e0d2);
            color: #198754;
            border: 1px solid #b8e0d2;
        }

        .task-title-clickable {
            cursor: pointer;
            color: #0d6efd;
            transition: color 0.2s;
            font-weight: 500;
            line-height: 1.3;
        }

        .task-title-clickable:hover {
            color: #0a58ca;
            text-decoration: underline;
        }

        /* Мобильная адаптация */
        @media (max-width: 768px) {
            .task-item {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.75rem 0.5rem;
            }

            .task-item > i {
                position: absolute;
                left: 0.5rem;
                top: 0.75rem;
            }

            .task-item .flex-grow-1 {
                padding-left: 1.75rem;
                width: 100%;
            }

            .badge {
                align-self: flex-start;
                margin-top: 0.25rem;
            }

            .modal-lg-custom {
                margin: 0.5rem;
                max-width: calc(100% - 1rem);
            }

            .modal-dialog {
                margin: 0.5rem;
            }
        }

        /* Для очень маленьких экранов */
        @media (max-width: 576px) {
            .task-item {
                padding: 0.65rem 0.5rem;
            }

            .task-title-clickable {
                font-size: 0.95rem;
            }

            .task-item .flex-grow-1 {
                padding-left: 1.5rem;
            }

            .task-item > i {
                font-size: 0.875rem;
                top: 0.65rem;
                left: 0.5rem;
            }
        }

        /* Панель поиска и фильтров - мобильная адаптация */
        .search-container {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        @media (max-width: 768px) {
            .search-container {
                padding: 1rem;
                border-radius: 10px;
                margin-bottom: 1rem;
            }

            .search-container .row {
                margin-bottom: 0.75rem !important;
            }

            .search-container .col-md-6 {
                margin-bottom: 0.75rem;
            }
        }

        @media (max-width: 576px) {
            .search-container {
                padding: 0.875rem;
            }

            #searchInput {
                font-size: 0.9rem;
            }

            .filter-btn {
                font-size: 0.8rem;
                padding: 0.4rem 0.7rem;
            }
        }

        /* Фильтры - мобильная адаптация */
        .filter-btn {
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-size: 0.825rem;
            transition: all 0.2s;
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 768px) {
            .filter-btn {
                flex: 0 1 auto;
                padding: 0.4rem 0.6rem;
            }

            #activeFilters {
                font-size: 0.85rem;
            }

            .filter-badge {
                font-size: 0.8rem;
                padding: 0.3rem 0.6rem;
            }
        }

        @media (max-width: 576px) {
            .filter-btn {
                font-size: 0.75rem;
                padding: 0.35rem 0.5rem;
            }

            .filter-btn i {
                font-size: 0.8rem;
            }
        }

        /* Хедер - мобильная адаптация */
        @media (max-width: 768px) {
            header .container {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }

            header .btn-lg {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }

            header .btn-lg i {
                font-size: 1rem;
            }

            header .d-flex.align-items-center.gap-3 {
                gap: 0.75rem !important;
            }

            header h1 {
                font-size: 1.25rem;
            }

            header p.text-muted {
                font-size: 0.75rem;
            }

            .bg-primary.bg-gradient {
                width: 40px !important;
                height: 40px !important;
            }

            .bg-primary.bg-gradient i {
                font-size: 1.25rem;
            }
        }

        @media (max-width: 576px) {
            header {
                padding-top: 0.75rem !important;
                padding-bottom: 0.75rem !important;
            }

            header .btn-outline-danger.btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }

            .d-flex.align-items-center.gap-2.p-2.border.rounded-3 {
                padding: 0.5rem !important;
            }

            .bg-light.rounded-circle {
                width: 32px !important;
                height: 32px !important;
            }
        }

        /* Модальные окна - мобильная адаптация */
        .modal-lg-custom {
            max-width: 700px;
        }

        @media (max-width: 768px) {
            .modal-lg-custom {
                max-width: 95%;
                margin: 0.5rem auto;
            }

            .modal-content {
                border-radius: 12px;
            }

            .modal-header {
                padding: 1rem 1rem 0.75rem;
            }

            .modal-body {
                padding: 1rem;
            }

            .modal-footer {
                padding: 0.75rem 1rem;
                flex-wrap: wrap;
            }

            .modal-footer .btn {
                margin-bottom: 0.25rem;
            }

            .modal-title {
                font-size: 1.1rem;
            }

            .form-label {
                font-size: 0.9rem;
                margin-bottom: 0.25rem;
            }

            .form-control, .form-select {
                font-size: 0.9rem;
                padding: 0.375rem 0.5rem;
            }

            .form-text {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 576px) {
            .modal-dialog {
                margin: 0.25rem;
            }

            .modal-header {
                padding: 0.875rem 0.875rem 0.625rem;
            }

            .modal-body {
                padding: 0.875rem;
            }

            .modal-footer {
                padding: 0.625rem 0.875rem;
            }

            .modal-title {
                font-size: 1rem;
            }

            .btn {
                font-size: 0.85rem;
                padding: 0.375rem 0.75rem;
            }

            .row.g-4 {
                --bs-gutter-x: 0.75rem;
                --bs-gutter-y: 0.75rem;
            }
        }

        /* Дополнительные классы для мобильной адаптации */
        .mobile-only {
            display: none !important;
        }

        .desktop-only {
            display: block !important;
        }

        @media (max-width: 768px) {
            .mobile-only {
                display: block !important;
            }

            .desktop-only {
                display: none !important;
            }

            .d-none-mobile {
                display: none !important;
            }

            .text-truncate-mobile {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 200px;
            }
        }

        /* Улучшенные стили для статусов */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            flex-shrink: 0;
        }

        @media (max-width: 576px) {
            .status-dot {
                width: 8px;
                height: 8px;
                margin-right: 4px;
            }

            small.text-muted {
                font-size: 0.8rem;
            }
        }

        .status-dot-completed {
            background-color: #198754;
        }

        .status-dot-pending {
            background-color: #6c757d;
        }

        .status-dot-overdue {
            background-color: #dc3545;
        }

        /* Фильтры и поиск */
        .filter-badge {
            background: #e9ecef;
            border: none;
            border-radius: 20px;
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            white-space: nowrap;
        }

        .active-filter {
            background: #0d6efd !important;
            color: white !important;
            border-color: #0d6efd !important;
        }

        .task-item.hidden {
            display: none !important;
        }

        .no-tasks {
            text-align: center;
            padding: 2.5rem 1rem;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .no-tasks {
                padding: 2rem 1rem;
            }

            .no-tasks .display-1 {
                font-size: 3.5rem;
            }

            .no-tasks .h4 {
                font-size: 1.25rem;
            }

            .no-tasks p {
                font-size: 0.9rem;
            }
        }

        /* Приоритет индикатор */
        .priority-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            display: inline-block;
            flex-shrink: 0;
        }

        .priority-high {
            background-color: #dc3545;
        }

        .priority-medium {
            background-color: #ffc107;
        }

        .priority-low {
            background-color: #198754;
        }

        /* Гамбургер меню для фильтров на мобильных */
        .filters-dropdown-mobile {
            display: none;
        }

        @media (max-width: 576px) {
            .filters-row {
                display: none;
            }

            .filters-dropdown-mobile {
                display: block;
            }

            .filters-dropdown-menu {
                max-height: 300px;
                overflow-y: auto;
            }

            .dropdown-item.active {
                background-color: #0d6efd;
                color: white;
            }
        }

        /* Счетчик задач */
        .tasks-counter {
            font-size: 0.85rem;
            color: #6c757d;
            background: #f8f9fa;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .tasks-counter {
                padding: 0.375rem 0.75rem;
                font-size: 0.8rem;
                margin-top: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Хедер -->
    <header class="border-bottom shadow-sm bg-white py-3 py-md-4 mb-4">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <!-- Левая часть: Заголовок и иконка -->
                <div class="d-flex align-items-center gap-2 gap-md-3">
                    <div class="bg-primary bg-gradient rounded-circle p-2 d-flex align-items-center justify-content-center shadow-sm" style="width: 48px; height: 48px;">
                        <i class="bi bi-check2-circle fs-4 text-white"></i>
                    </div>
                    <div>
                        <h1 class="h4 h3-md mb-0 fw-bold text-dark">Мои Задачи</h1>
                        <p class="text-muted small mb-0 d-none d-sm-block">Управление вашими задачами</p>
                    </div>
                </div>

                <!-- Правая часть: Кнопка и блок пользователя -->
                <div class="d-flex align-items-center gap-2 gap-md-3">
                    <!-- Блок пользователя -->
                    <div class="d-flex align-items-center gap-2">
                        {% if user.is_authenticated %}
                            <div class="d-flex align-items-center gap-1 gap-md-2 p-1 p-md-2 border rounded-3">
                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                    <i class="bi bi-person-fill text-primary"></i>
                                </div>
                                <div class="d-none d-sm-block">
                                    <span class="fw-medium small">Привет, {{ user.username }}!</span>
                                </div>
                                <form method="post" action="{% url 'logout' %}" class="m-0">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-danger btn-sm ms-1 ms-md-2">
                                        <i class="bi bi-box-arrow-right d-none d-sm-inline"></i>
                                        <span class="d-sm-none">Выйти</span>
                                    </button>
                                </form>
                            </div>
                        {% else %}
                            <a href="{% url 'login' %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-box-arrow-in-right"></i>
                                <span class="d-none d-md-inline">Войти</span>
                            </a>
                        {% endif %}
                    </div>

                    <!-- Кнопка создания задачи -->
                    <button type="button" class="btn btn-primary btn-lg shadow-sm d-flex align-items-center gap-1 gap-md-2 fw-medium" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                        <i class="bi bi-plus-circle"></i>
                        <span class="d-none d-md-inline">Создать задачу</span>
                        <span class="d-md-none">Создать</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Панель поиска и фильтров -->
        <div class="search-container">
            <div class="row mb-3">
                <div class="col-12 col-md-6 mb-3 mb-md-0">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text"
                               class="form-control border-start-0"
                               id="searchInput"
                               placeholder="Поиск задач...">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <!-- Десктопные фильтры -->
                    <div class="filters-row d-none d-sm-flex gap-2 flex-wrap">
                        <span class="text-muted align-self-center me-2 d-none d-md-block">Фильтры:</span>
                        <button class="btn btn-outline-primary filter-btn" data-filter="all">
                            <i class="bi bi-list-check"></i> <span class="d-none d-md-inline">Все</span>
                        </button>
                        <button class="btn btn-outline-primary filter-btn" data-filter="pending">
                            <i class="bi bi-clock"></i> <span class="d-none d-md-inline">Активные</span>
                        </button>
                        <button class="btn btn-outline-primary filter-btn" data-filter="completed">
                            <i class="bi bi-check-circle"></i> <span class="d-none d-md-inline">Выполненные</span>
                        </button>
                        <button class="btn btn-outline-primary filter-btn" data-filter="today">
                            <i class="bi bi-calendar-day"></i> <span class="d-none d-md-inline">Сегодня</span>
                        </button>
                        <button class="btn btn-outline-primary filter-btn" data-filter="high">
                            <i class="bi bi-exclamation-triangle"></i> <span class="d-none d-md-inline">Высокий</span>
                        </button>
                    </div>

                    <!-- Мобильные фильтры (выпадающий список) -->
                    <div class="filters-dropdown-mobile">
                        <div class="dropdown">
                            <button class="btn btn-outline-primary w-100 d-flex justify-content-between align-items-center" type="button" id="mobileFiltersDropdown" data-bs-toggle="dropdown">
                                <span><i class="bi bi-filter-left"></i> Фильтры</span>
                                <i class="bi bi-chevron-down"></i>
                            </button>
                            <ul class="dropdown-menu w-100 filters-dropdown-menu" aria-labelledby="mobileFiltersDropdown">
                                <li><a class="dropdown-item filter-dropdown-item active" href="#" data-filter="all"><i class="bi bi-list-check me-2"></i> Все задачи</a></li>
                                <li><a class="dropdown-item filter-dropdown-item" href="#" data-filter="pending"><i class="bi bi-clock me-2"></i> Активные</a></li>
                                <li><a class="dropdown-item filter-dropdown-item" href="#" data-filter="completed"><i class="bi bi-check-circle me-2"></i> Выполненные</a></li>
                                <li><a class="dropdown-item filter-dropdown-item" href="#" data-filter="today"><i class="bi bi-calendar-day me-2"></i> Сегодня</a></li>
                                <li><a class="dropdown-item filter-dropdown-item" href="#" data-filter="high"><i class="bi bi-exclamation-triangle me-2"></i> Высокий приоритет</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="clearAllFilters"><i class="bi bi-x-circle me-2"></i> Сбросить все фильтры</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Активные фильтры -->
            <div class="d-flex align-items-center flex-wrap gap-1 gap-md-2" id="activeFilters">
                <small class="text-muted me-2">Фильтры:</small>
            </div>
        </div>

        <!-- Список задач -->
        <div class="task-list" id="tasksContainer">
            {% for task in tasks %}
                <div class="task-item"
                     data-task-id="{{ task.id }}"
                     data-task-title="{{ task.title|lower }}"
                     data-task-description="{{ task.description|lower }}"
                     data-task-completed="{{ task.completed|yesno:'true,false' }}"
                     data-task-due-date="{{ task.due_date|date:'Y-m-d'|default:'' }}"
                     data-task-due-time="{{ task.due_time|time:'H:i'|default:'' }}"
                     data-task-priority="{{ task.priority|default:'MEDIUM' }}">
                    {% if task.completed %}
                        <i class="bi bi-check-circle-fill text-success"></i>
                    {% else %}
                        {% if task.due_date and task.due_date < today %}
                            <i class="bi bi-exclamation-circle-fill text-danger"></i>
                        {% else %}
                            <i class="bi bi-circle text-primary"></i>
                        {% endif %}
                    {% endif %}
                    <div class="flex-grow-1">
                        <div class="task-title-clickable fw-medium mb-1"
                             data-bs-toggle="modal"
                             data-bs-target="#viewTaskModal"
                             data-task-id="{{ task.id }}"
                             data-task-title="{{ task.title }}"
                             data-task-description="{{ task.description }}"
                             data-task-completed="{{ task.completed|yesno:'true,false' }}"
                             data-task-priority="{{ task.priority|default:'MEDIUM' }}"
                             data-task-due-date="{{ task.due_date|date:'Y-m-d'|default:'' }}"
                             data-task-due-time="{{ task.due_time|time:'H:i'|default:'' }}">
                            {{ task.title }}
                        </div>
                        <div class="d-flex align-items-center flex-wrap gap-1 gap-md-2">
                            {% if task.completed %}
                                <span class="status-dot status-dot-completed"></span>
                                <small class="text-success">Выполнено</small>
                            {% else %}
                                {% if task.due_date and task.due_date < today %}
                                    <span class="status-dot status-dot-overdue"></span>
                                    <small class="text-danger">Просрочено</small>
                                {% else %}
                                    <span class="status-dot status-dot-pending"></span>
                                    <small class="text-muted">В процессе</small>
                                {% endif %}
                            {% endif %}

                            {% if task.due_date %}
                                <small class="text-muted d-none d-sm-inline">•</small>
                                <small class="text-muted">
                                    <i class="bi bi-calendar d-inline d-sm-none"></i>
                                    <span class="d-none d-sm-inline">
                                        <i class="bi bi-calendar"></i>
                                        {{ task.due_date|date:"d.m.Y" }}
                                    </span>
                                    <span class="d-sm-none">
                                        {{ task.due_date|date:"d.m" }}
                                    </span>
                                    {% if task.due_time %}
                                        <span class="d-none d-sm-inline">, {{ task.due_time|time:"H:i" }}</span>
                                    {% endif %}
                                </small>
                            {% endif %}
                        </div>
                    </div>
                    {% if task.priority == 'HIGH' %}
                        <span class="badge badge-high">
                            <span class="priority-indicator priority-high"></span>
                            <span class="d-none d-sm-inline">Высокий</span>
                            <span class="d-sm-none">Выс.</span>
                        </span>
                    {% elif task.priority == 'MEDIUM' %}
                        <span class="badge badge-medium">
                            <span class="priority-indicator priority-medium"></span>
                            <span class="d-none d-sm-inline">Средний</span>
                            <span class="d-sm-none">Ср.</span>
                        </span>
                    {% elif task.priority == 'LOW' %}
                        <span class="badge badge-low">
                            <span class="priority-indicator priority-low"></span>
                            <span class="d-none d-sm-inline">Низкий</span>
                            <span class="d-sm-none">Низ.</span>
                        </span>
                    {% else %}
                        <span class="badge badge-medium">
                            <span class="priority-indicator priority-medium"></span>
                            <span class="d-none d-sm-inline">Средний</span>
                            <span class="d-sm-none">Ср.</span>
                        </span>
                    {% endif %}
                </div>
            {% empty %}
                <div class="no-tasks">
                    <i class="bi bi-clipboard-x display-1 text-muted mb-3"></i>
                    <p class="h4 text-muted mb-2">Задач пока нет</p>
                    <p class="text-muted mb-3">Создайте свою первую задачу</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                        <i class="bi bi-plus-circle"></i> Создать задачу
                    </button>
                </div>
            {% endfor %}
        </div>

        <!-- Счетчик задач -->
        <div class="tasks-counter text-center">
            <small class="text-muted">
                Показано: <span id="visibleTasksCount">0</span> из <span id="totalTasksCount">0</span> задач
            </small>
        </div>
    </div>

    <!-- Модальное окно для создания задачи -->
    <div class="modal fade" id="createTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Создать новую задачу</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <form method="post" action="{% url 'create_task' %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="id_title" class="form-label">Заголовок <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="id_title" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label for="id_description" class="form-label">Описание</label>
                            <textarea class="form-control" id="id_description" name="description" rows="3" placeholder="Описание задачи (необязательно)"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_priority" class="form-label">Приоритет</label>
                                <select class="form-select" id="id_priority" name="priority">
                                    <option value="LOW">Низкий</option>
                                    <option value="MEDIUM" selected>Средний</option>
                                    <option value="HIGH">Высокий</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check h-100 d-flex align-items-end">
                                    <input type="checkbox" class="form-check-input" id="id_completed" name="completed">
                                    <label class="form-check-label" for="id_completed">Выполнено</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_due_date" class="form-label">Срок выполнения</label>
                                <input type="date" class="form-control" id="id_due_date" name="due_date">
                                <div class="form-text small">Дата (необязательно)</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_due_time" class="form-label">Время</label>
                                <input type="time" class="form-control" id="id_due_time" name="due_time">
                                <div class="form-text small">Время (необязательно)</div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-primary">Сохранить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно для просмотра и редактирования задачи -->
    <div class="modal fade" id="viewTaskModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-lg-custom">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Просмотр и редактирование задачи</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <form id="editTaskForm" method="post" action="">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" id="edit_task_id" name="task_id">

                        <div class="mb-3">
                            <label for="edit_title" class="form-label">Заголовок <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_title" name="title" required>
                        </div>

                        <div class="mb-3">
                            <label for="edit_description" class="form-label">Описание</label>
                            <textarea class="form-control" id="edit_description" name="description" rows="4"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit_priority" class="form-label">Приоритет</label>
                                <select class="form-select" id="edit_priority" name="priority">
                                    <option value="LOW">Низкий</option>
                                    <option value="MEDIUM">Средний</option>
                                    <option value="HIGH">Высокий</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check h-100 d-flex align-items-end">
                                    <input type="checkbox" class="form-check-input" id="edit_completed" name="completed">
                                    <label class="form-check-label" for="edit_completed">Выполнено</label>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit_due_date" class="form-label">Срок выполнения</label>
                                <input type="date" class="form-control" id="edit_due_date" name="due_date">
                                <div class="form-text small">Дата (необязательно)</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_due_time" class="form-label">Время</label>
                                <input type="time" class="form-control" id="edit_due_time" name="due_time">
                                <div class="form-text small">Время (необязательно)</div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer justify-content-between">
                        <!-- Левая часть: кнопка удаления -->
                        <div>
                            <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                                <i class="bi bi-trash"></i> <span class="d-none d-sm-inline">Удалить</span>
                            </button>
                        </div>

                        <!-- Правая часть: кнопки отмены и сохранения -->
                        <div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                            <button type="submit" class="btn btn-primary">Сохранить</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения удаления -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">Подтверждение удаления</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Вы уверены, что хотите удалить эту задачу? Это действие нельзя отменить.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <form id="deleteTaskForm" method="post" action="" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" id="delete_task_id" name="task_id">
                        <button type="submit" class="btn btn-danger">Удалить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Обработчик открытия модального окна с задачей
        document.addEventListener('DOMContentLoaded', function() {
            const viewTaskModal = document.getElementById('viewTaskModal');

            viewTaskModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;

                // Извлекаем данные из data-* атрибутов
                const taskId = button.getAttribute('data-task-id');
                const taskTitle = button.getAttribute('data-task-title');
                const taskDescription = button.getAttribute('data-task-description');
                const taskCompleted = button.getAttribute('data-task-completed') === 'true';
                const taskPriority = button.getAttribute('data-task-priority');
                const taskDueDate = button.getAttribute('data-task-due-date');
                const taskDueTime = button.getAttribute('data-task-due-time');

                // Заполняем форму редактирования
                document.getElementById('edit_task_id').value = taskId;
                document.getElementById('delete_task_id').value = taskId;
                document.getElementById('edit_title').value = taskTitle;
                document.getElementById('edit_description').value = taskDescription;
                document.getElementById('edit_priority').value = taskPriority;
                document.getElementById('edit_completed').checked = taskCompleted;
                document.getElementById('edit_due_date').value = taskDueDate;
                document.getElementById('edit_due_time').value = taskDueTime;

                // Устанавливаем action для форм
                document.getElementById('editTaskForm').action = `update/${taskId}`;
                document.getElementById('deleteTaskForm').action = `delete/${taskId}`;
            });

            // Инициализация системы поиска и фильтрации
            initSearchAndFilter();
        });

        // Функция подтверждения удаления
        function confirmDelete() {
            const deleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            deleteModal.show();
        }

        // Система поиска и фильтрации
        function initSearchAndFilter() {
            const searchInput = document.getElementById('searchInput');
            const clearSearchBtn = document.getElementById('clearSearch');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const filterDropdownItems = document.querySelectorAll('.filter-dropdown-item');
            const activeFiltersContainer = document.getElementById('activeFilters');
            const taskItems = document.querySelectorAll('.task-item');
            const totalTasksCount = document.getElementById('totalTasksCount');
            const clearAllFiltersBtn = document.getElementById('clearAllFilters');
            const mobileFiltersDropdown = document.getElementById('mobileFiltersDropdown');

            let activeFilters = {
                search: '',
                status: 'all',
                priority: 'all',
                date: 'all'
            };

            // Устанавливаем общее количество задач
            totalTasksCount.textContent = taskItems.length;

            // Функция обновления счетчика видимых задач
            function updateVisibleTasksCount() {
                const visibleTasks = document.querySelectorAll('.task-item:not(.hidden)').length;
                document.getElementById('visibleTasksCount').textContent = visibleTasks;
            }

            // Функция фильтрации задач
            function filterTasks() {
                const today = new Date().toISOString().split('T')[0];

                taskItems.forEach(task => {
                    let isVisible = true;

                    // Фильтр по поиску
                    if (activeFilters.search) {
                        const title = task.getAttribute('data-task-title');
                        const description = task.getAttribute('data-task-description');
                        const searchTerm = activeFilters.search.toLowerCase();

                        if (!title.includes(searchTerm) && !description.includes(searchTerm)) {
                            isVisible = false;
                        }
                    }

                    // Фильтр по статусу
                    if (activeFilters.status !== 'all') {
                        const completed = task.getAttribute('data-task-completed');
                        if (activeFilters.status === 'completed' && completed !== 'true') {
                            isVisible = false;
                        }
                        if (activeFilters.status === 'pending' && completed === 'true') {
                            isVisible = false;
                        }
                    }

                    // Фильтр по приоритету
                    if (activeFilters.priority !== 'all') {
                        const priority = task.getAttribute('data-task-priority');
                        if (activeFilters.priority !== priority.toLowerCase()) {
                            isVisible = false;
                        }
                    }

                    // Фильтр по дате
                    if (activeFilters.date !== 'all') {
                        const dueDate = task.getAttribute('data-task-due-date');
                        if (activeFilters.date === 'today' && dueDate !== today) {
                            isVisible = false;
                        }
                    }

                    // Применение видимости
                    if (isVisible) {
                        task.classList.remove('hidden');
                    } else {
                        task.classList.add('hidden');
                    }
                });

                updateVisibleTasksCount();
                updateActiveFiltersDisplay();
                updateMobileDropdownText();
            }

            // Функция обновления отображения активных фильтров
            function updateActiveFiltersDisplay() {
                activeFiltersContainer.innerHTML = '<small class="text-muted me-2">Фильтры:</small>';

                if (activeFilters.search) {
                    const badge = createFilterBadge(`Поиск: "${activeFilters.search}"`, 'search');
                    activeFiltersContainer.appendChild(badge);
                }

                if (activeFilters.status !== 'all') {
                    const statusText = activeFilters.status === 'completed' ? 'Выполненные' : 'Активные';
                    const badge = createFilterBadge(statusText, 'status');
                    activeFiltersContainer.appendChild(badge);
                }

                if (activeFilters.priority !== 'all') {
                    const priorityText = activeFilters.priority === 'high' ? 'Высокий' :
                                       activeFilters.priority === 'medium' ? 'Средний' : 'Низкий';
                    const badge = createFilterBadge(priorityText, 'priority');
                    activeFiltersContainer.appendChild(badge);
                }

                if (activeFilters.date !== 'all') {
                    const dateText = activeFilters.date === 'today' ? 'Сегодня' : 'Все';
                    const badge = createFilterBadge(dateText, 'date');
                    activeFiltersContainer.appendChild(badge);
                }

                // Показать "Все" если нет активных фильтров
                if (!activeFilters.search && activeFilters.status === 'all' &&
                    activeFilters.priority === 'all' && activeFilters.date === 'all') {
                    const badge = createFilterBadge('Все задачи', 'all');
                    activeFiltersContainer.appendChild(badge);
                }
            }

            // Функция обновления текста мобильного dropdown
            function updateMobileDropdownText() {
                let filterText = 'Фильтры';
                let hasFilter = false;

                if (activeFilters.status !== 'all') {
                    filterText = activeFilters.status === 'completed' ? 'Выполненные' : 'Активные';
                    hasFilter = true;
                }

                if (activeFilters.priority !== 'all') {
                    filterText = activeFilters.priority === 'high' ? 'Высокий' :
                               activeFilters.priority === 'medium' ? 'Средний' : 'Низкий';
                    hasFilter = true;
                }

                if (activeFilters.date !== 'all') {
                    filterText = 'Сегодня';
                    hasFilter = true;
                }

                if (hasFilter) {
                    mobileFiltersDropdown.innerHTML = `<span><i class="bi bi-filter-left"></i> ${filterText}</span> <i class="bi bi-chevron-down"></i>`;
                } else {
                    mobileFiltersDropdown.innerHTML = `<span><i class="bi bi-filter-left"></i> Фильтры</span> <i class="bi bi-chevron-down"></i>`;
                }

                // Обновляем активный пункт в dropdown
                filterDropdownItems.forEach(item => {
                    item.classList.remove('active');
                    const itemFilter = item.getAttribute('data-filter');

                    if (itemFilter === 'all' &&
                        activeFilters.status === 'all' &&
                        activeFilters.priority === 'all' &&
                        activeFilters.date === 'all') {
                        item.classList.add('active');
                    } else if (itemFilter === activeFilters.status && activeFilters.status !== 'all') {
                        item.classList.add('active');
                    } else if (itemFilter === activeFilters.priority && activeFilters.priority !== 'all') {
                        item.classList.add('active');
                    } else if (itemFilter === activeFilters.date && activeFilters.date !== 'all') {
                        item.classList.add('active');
                    }
                });
            }

            // Функция создания бейджа фильтра
            function createFilterBadge(text, type) {
                const badge = document.createElement('button');
                badge.className = 'filter-badge btn btn-sm';
                badge.innerHTML = `
                    ${text}
                    <i class="bi bi-x" data-filter-type="${type}"></i>
                `;

                badge.addEventListener('click', function(e) {
                    if (e.target.closest('.bi-x')) {
                        e.stopPropagation();
                        removeFilter(type);
                    }
                });

                return badge;
            }

            // Функция удаления фильтра
            function removeFilter(type) {
                switch(type) {
                    case 'search':
                        activeFilters.search = '';
                        searchInput.value = '';
                        break;
                    case 'status':
                        activeFilters.status = 'all';
                        updateFilterButtons();
                        break;
                    case 'priority':
                        activeFilters.priority = 'all';
                        updateFilterButtons();
                        break;
                    case 'date':
                        activeFilters.date = 'all';
                        updateFilterButtons();
                        break;
                }

                filterTasks();
            }

            // Функция обновления кнопок фильтров
            function updateFilterButtons() {
                filterButtons.forEach(btn => {
                    const filter = btn.dataset.filter;
                    btn.classList.remove('active-filter');

                    if (filter === 'all' &&
                        activeFilters.status === 'all' &&
                        activeFilters.priority === 'all' &&
                        activeFilters.date === 'all') {
                        btn.classList.add('active-filter');
                    } else if (filter === activeFilters.status && activeFilters.status !== 'all') {
                        btn.classList.add('active-filter');
                    } else if (filter === activeFilters.priority && activeFilters.priority !== 'all') {
                        btn.classList.add('active-filter');
                    } else if (filter === activeFilters.date && activeFilters.date !== 'all') {
                        btn.classList.add('active-filter');
                    }
                });
            }

            // Обработчик поиска
            searchInput.addEventListener('input', function() {
                activeFilters.search = this.value.trim();
                filterTasks();
            });

            // Очистка поиска
            clearSearchBtn.addEventListener('click', function() {
                searchInput.value = '';
                activeFilters.search = '';
                filterTasks();
            });

            // Обработчики кнопок фильтров (десктоп)
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const filter = this.dataset.filter;
                    applyFilter(filter);
                });
            });

            // Обработчики пунктов dropdown (мобильные)
            filterDropdownItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const filter = this.getAttribute('data-filter');
                    applyFilter(filter);

                    // Закрываем dropdown на мобильных
                    const dropdown = bootstrap.Dropdown.getInstance(mobileFiltersDropdown);
                    if (dropdown) {
                        dropdown.hide();
                    }
                });
            });

            // Обработчик сброса всех фильтров
            if (clearAllFiltersBtn) {
                clearAllFiltersBtn.addEventListener('click', function(e) {
                    e.preventDefault();

                    activeFilters = {
                        search: '',
                        status: 'all',
                        priority: 'all',
                        date: 'all'
                    };

                    searchInput.value = '';
                    updateFilterButtons();
                    filterTasks();

                    // Закрываем dropdown на мобильных
                    const dropdown = bootstrap.Dropdown.getInstance(mobileFiltersDropdown);
                    if (dropdown) {
                        dropdown.hide();
                    }
                });
            }

            // Функция применения фильтра
            function applyFilter(filter) {
                // Установка фильтров
                switch(filter) {
                    case 'all':
                        activeFilters.status = 'all';
                        activeFilters.priority = 'all';
                        activeFilters.date = 'all';
                        break;
                    case 'pending':
                        activeFilters.status = 'pending';
                        activeFilters.priority = 'all';
                        activeFilters.date = 'all';
                        break;
                    case 'completed':
                        activeFilters.status = 'completed';
                        activeFilters.priority = 'all';
                        activeFilters.date = 'all';
                        break;
                    case 'today':
                        activeFilters.status = 'all';
                        activeFilters.priority = 'all';
                        activeFilters.date = 'today';
                        break;
                    case 'high':
                        activeFilters.status = 'all';
                        activeFilters.priority = 'high';
                        activeFilters.date = 'all';
                        break;
                }

                updateFilterButtons();
                filterTasks();
            }

            // Начальная инициализация
            updateFilterButtons();
            updateVisibleTasksCount();
            updateActiveFiltersDisplay();
            updateMobileDropdownText();

            // Адаптация размера шрифта для мобильных
            if (window.innerWidth < 768) {
                document.body.style.fontSize = '15px';
            }
        }

        // Обработчик изменения размера окна
        window.addEventListener('resize', function() {
            if (window.innerWidth < 768) {
                document.body.style.fontSize = '15px';
            } else {
                document.body.style.fontSize = '';
            }
        });
    </script>
</body>
</html>